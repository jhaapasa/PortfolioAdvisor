#!/bin/bash
set -e

# Setup script for git worktree instances
# Creates venv, installs dependencies, and configures .env

echo "=== Setting up worktree environment ==="

# 1. Create virtual environment
echo "Creating Python virtual environment..."
python3 -m venv .venv

# 2. Activate venv and install package with dependencies
echo "Installing package and dependencies..."
source .venv/bin/activate
pip install --upgrade pip
pip install -e .

# 3. Create .env file from env.example with reasonable defaults
echo "Creating .env file..."
if [ -f .env ]; then
    echo "⚠️  .env already exists, skipping creation"
else
    cat > .env << 'EOF'
# Core paths are passed via CLI: --input-dir, --output-dir

# OpenAI / LLM (optional for stubbed runs)
OPENAI_API_KEY=
OPENAI_BASE_URL=
OPENAI_MODEL=gpt-4o-mini
REQUEST_TIMEOUT_S=60
MAX_TOKENS=
TEMPERATURE=0.2

# Logging
LOG_LEVEL=INFO
LOG_FORMAT=plain
VERBOSE=
AGENT_PROGRESS=

# Caching
# When set to 1, bypasses cache lookup but writes fresh results to cache
SKIP_LLM_CACHE=

# Parser (LLM Parsing Agent)
PARSER_MAX_RETRIES=2
PARSER_MAX_DOC_CHARS=20000


# Polygon / Resolver
# Wavelet analysis
# Enable wavelet analysis and configure decomposition level J (1-8)
WAVELET=
WAVELET_LEVEL=5

# Polygon API key used by the Ticker Resolver Agent
POLYGON_API_KEY=
# Optional base URL override for Polygon (leave empty for default)
POLYGON_BASE_URL=
# HTTP timeout (seconds) for Polygon client
POLYGON_TIMEOUT_S=10

# Resolver defaults
# Default market locale when provider does not specify one
RESOLVER_DEFAULT_LOCALE=us
# Preferred primary exchange MICs in ranking (comma-separated)
RESOLVER_PREFERRED_MICS=XNAS,XNYS,ARCX
# Confidence threshold (0-1) below which matches are treated as unresolved
RESOLVER_CONFIDENCE_THRESHOLD=0.6

EOF
    echo "✓ Created .env file (add your API keys manually)"
fi

echo ""
echo "=== Worktree setup complete! ==="
echo ""
echo "Next steps:"
echo "  1. Edit .env and add your API keys (OPENAI_API_KEY, POLYGON_API_KEY)"
echo "  2. Activate the virtual environment: source .venv/bin/activate"
echo "  3. Run tests to verify: pytest -q"
echo ""

